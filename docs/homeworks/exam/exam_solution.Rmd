---
title: "Решение экзамена"
output: 
  html_document:
    # toc: TRUE
    # toc_float: TRUE
    # toc_depth: 4
    highlight: pygments
editor_options: 
  chunk_output_type: console
---
<style>
h1,
h2,
h3,
h4,
h5,
h6  {
  color: #317eac;
}
</style>
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

### Задание №0 (1 балл)

Подгрузите следующие пакеты.

```{r}
packages <- c('readr', 'dplyr', 'tidyr', 'ggplot2', 'fastDummies',
              'rvest', 'stringr', 'naniar', 'tibble', 'Metrics', 'readr')
# install.packages(packages)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rvest)
library(stringr)
library(naniar)
library(tibble)
library(Metrics)
library(fastDummies)
library(readr)
```

### Задание №1 (24 балла)

Нужно спарсить одну страницу сайта [ЦИАН](https://www.cian.ru/). Запрос можно оставить как на картинке или сделать какой-то свой.

<center>
![](pictures/cian.png){width=800px}
</center>

Парсим только первую страничку, поэтому не нужно писать никаких `for`. Выкачать нужно все цены, которые находятся на странице, привести их к числовому формату и найти среднее значение.

<center>
![](pictures/cian2.png){width=700px}
</center>

_Решение:_ 

Давайте возьмем следующий URL. Можете открыть его в браузере.

```{r}
url <- 'https://www.cian.ru/cat.php?deal_type=sale&engine_version=2&offer_type=flat&region=1&room1=1&room2=1&room3=1'
```

Загрузим html-страницу в R.

```{r}
cian <- read_html(url)
```

Найдем блок, который отвечат за цену. Видим, что это __div__ и у него есть аттрибут __class__. Воспользуемся этим и напишем xpath. У нас будет 28 блоков, в которых лежат цены. Вытащим текст из этих блоков. В этих ценах есть непонятные символы и пробелы. Уберем их через `str_replace_all`. Можно было удалить с помощью функции `str_remove_all`. А теперь приведем все к числовому типу.

```{r}
price <- cian %>%
  html_nodes(xpath = "//div[@class='c6e8ba5398--header--1dF9r']") %>%
  html_text() %>% 
  str_replace_all('\u20bd', '') %>%
  str_replace_all(' ', '') %>%
  as.numeric()
```

Найдем просто среднее нашего массива.

```{r}
mean(price)
```

### Задание №2 (35 баллов)

С того же ЦИАНа я спарсил для вас информацию о квартирах в районе Проспекта Вернадского (Юго-запад). 

```{r}
url <- 'https://raw.githubusercontent.com/ahmedushka7/R/master/docs/homeworks/exam/data/cian.csv'
data <- read_csv(url)
```

В данном датасете наблюдением является квартира. Каждая квартира имеет следующие характеристики ( переменные):

* `price` -- цена квартиры в рублях;
* `subway` -- удаленность до метро; до слэша: количество минут, после слэша: способ добраться до метро (walk -- пешком, transport -- обественный транспорт);
* `rooms` -- количество комнат;
* `metrs` -- количество квадратных метров;
* `url` -- ссылка объявления на сайте ЦИАН;
* `type` -- тип квартиры (`first` -- новостройка, `second` -- вторичка)

__Задания:__

1. Сколько наблюдений и переменных в датасете?

```{r}
glimpse(data)
```

2. Имеются ли пропущенные значения?

```{r}
vis_miss(data)
```

3. Постарайтесь выполнить все следующие операции с помощью pipe (`%>%`).
    - Удалите переменную `url`
    - Перевести цену квартир в миллионы рублей.
    - Разделить переменную `subway` на две отдельные переменные.
    - Все ли переменные имеют нужный тип (числовой, строковый)? Если нет, то приведите их к нужному формату.
    
```{r}
clean_data <- data %>%
  mutate(price = price / 10**6) %>%
  separate('subway', into = c('subway_time', 'subway_type'), sep = '/', convert = T) %>%
  select(-url) %>%
  mutate(metrs = as.numeric(metrs))
```
    
4. Постройте гистограмму распределения цены. Постройте гистограмму распределения в разрезе количества комнат. 

```{r}
ggplot(clean_data, aes(x = price)) + 
  geom_histogram(fill = 'darkblue', color = 'black', bins = 25) + 
  labs(title = 'Распределение цен на квартиры в районе Проспект Вернадского',
       x = 'Цена (в миллионах рублей)',
       y = 'Количество')
```

```{r}
ggplot(clean_data, aes(x = price, fill = factor(rooms))) + 
  geom_histogram(color = 'black', bins = 25) + 
  labs(title = 'Распределение цен на квартиры в районе Проспект Вернадского',
       x = 'Цена (в миллионах рублей)',
       y = 'Количество',
       fill = 'Количество комнат')
```

5. Сколько в среднем стоят квартиры в разрезе количества комнат? Сколько в среднем квадратных метров в разрезе количества комнат? 

```{r}
clean_data %>%
  group_by(rooms) %>%
  summarise(price = mean(price))
```

6. Сколько новостроек, а сколько вторичек в нашем датасете?

```{r}
clean_data %>%
  dplyr::count(type)
```

### Задание №3 (40 баллов)

У вас есть два набора данных `train` и `test`. Вам нужно попробовать построить наилучшую модель для прогнозирования цены квартиры (`price`). Метрикой качества будет __MAPE__. Помните, что эта метрика качества несимметрична.

```{r}
url_train <- 'https://raw.githubusercontent.com/ahmedushka7/R/master/docs/homeworks/exam/data/train.csv'
url_test <- 'https://raw.githubusercontent.com/ahmedushka7/R/master/docs/homeworks/exam/data/test.csv'

train <- read_csv(url_train)
test <- read_csv(url_test)
```

Если в качестве признака вы взяли площадь квартиры (квадратные метры), то проинтепретируйте коэффициент перед ним. А также нарисуйте график зависимости таргета от площади квартиры.

__Решение:__

__1.__

Очевидным кажется зависимость цены от площади квартиры. Попробуем нарисовать график.

```{r}
ggplot(train, aes(metrs, price)) +
  geom_point() +
  geom_smooth(se = F, method = 'lm')
```

Зависимость есть. Попробуем построить обычную парную регрессию.

```{r}
model1 <- lm(price ~ metrs, data = train)
pred1_train <- predict(model1, train)
mape(predicted = pred1_train, actual = train$price)

pred1_test <- predict(model1, test)
mape(predicted = pred1_test, actual = test$price)
```

__2.__

Попробуем добавить категориальную переменную: количество комнат.

```{r}
train <- dummy_cols(train, select_columns = 'rooms')
test <- dummy_cols(test, select_columns = 'rooms')

model2 <- lm(price ~ metrs + rooms_1 + rooms_2 + rooms_3 - 1, data = train)
pred2_train <- predict(model2, train)
mape(predicted = pred2_train, actual = train$price)

pred2_test <- predict(model2, test)
mape(predicted = pred2_test, actual = test$price)
```

```{r}
ggplot(train, aes(metrs, price, color = factor(rooms))) +
  geom_point() +
  geom_smooth(se = F, method = 'lm')
```

__3.__

Попробуем выкинуть выбросы.

```{r}
train <- train %>% filter(price < 70)

model3 <- lm(price ~ metrs + rooms_1 + rooms_2 + rooms_3 - 1, data = train)
pred3_train <- predict(model3, train)
mape(predicted = pred3_train, actual = train$price)

pred3_test <- predict(model3, test)
mape(predicted = pred3_test, actual = test$price)
```

```{r}
ggplot(train, aes(metrs, price, color = factor(rooms))) +
  geom_point() +
  geom_smooth(se = F, method = 'lm')
```

Можно попробовать сделать еще что-то, но этого достаточно для полного балла.