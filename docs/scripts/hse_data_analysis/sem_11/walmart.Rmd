---
title: "Walmart"
author: "Зарманбетов Ахмед"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
    highlight: pygments
    #df_print: paged
editor_options: 
  chunk_output_type: console
---
<style>
h1,
h2,
h3,
h4,
h5,
h6  {
  color: #317eac;
}
</style>
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = TRUE)
```

### Подгрузка пакетов

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(Metrics)
library(naniar)
```

### Данные

Нам предоставлены исторические данные о продажах 45 магазинов Walmart, расположенных в разных регионах. В каждом магазине есть несколько отделов, и нам поручено прогнозировать продажи в каждом магазине для каждого отдела.

Зачем нам прогнозировать продажи?

* Нельзя привозить в магазин слишком мало товара, потребителям его может не хватить. Мало того, что они не принесут нам денег, так ещё и станут менее лояльными: "Не поедем в этот магазин. Там вечно ничего нет. Погнали лучше в Магнолию сходим. Там всё есть."
* Нельзя привозить в магазин слишком много товара. Его нужно хранить. Это лишние расходы. Более того, товар может протухнуть. Придётся его списывать. Это тоже довольно неприятно.

```{r}
walmart <- read_csv('data/walmart.csv')
```

Нам доступны следующие переменные:

* `Weekly_Sales` -- объём продаж в данную неделю в данном отделе
* `Store` -- номер магазина;
* `Type` -- тип магазина;
* `Size` -- размер магазина;
* `Dept` -- номер отдела;
* `Date` -- дата;
* `IsHoliday` -- является ли неделя праздничной;
* `Temperature` -- средняя температура в регионе в градусах по Фаренгейту;
* `Fuel_Price` -- стоимость топлива в регионе;
* `MarkDown1-5` -- данные, связанные с рекламными уценками, которые запускает Walmart. Данные уценки доступны только после ноября 2011 года и доступны не для всех магазинов. Данные анонимизированы. Непонятно на какие именно товары производилась уценка и в каких количествах. Компании часто анонимизируют данные, когда выкладывают их в открытый доступ.
* `CPI` -- индекс потребительских цен;
* `Unemployment` -- уровень безработицы.
* `next_Weekly_Sales` -- объём продаж в следующую неделю в данном отделе (target)

```{r}
glimpse(walmart)
```

### Изучение данных

#### Пропущенные значения

Давайте сначала разберемся с пропущенными значениями. Набор данных достаточно большой, поэтому не будет его рисовать. Посмотрим на статистики.

```{r}
miss_var_summary(walmart)
```

Видим, что пропущенные значения есть только в переменных Markdown1 - Markdown5. Их достаточно много, поэтому просто заменить средним нет смысла. Давайте выбросим их из нашего датасета.

```{r}
walmart <- walmart %>%
  select(-starts_with('MarkDown'))
```
 
Теперь в нашем наборе данных нет пропущенных значений.

```{r}
n_miss(walmart)
```

#### Временной ряд продаж

Давайте немного изучим наши данные перед тем как строить модель. Построим временной ряд продаж.

```{r}
walmart %>%
  group_by(Date) %>%
  summarise(Mean_Weekly_Sales = mean(Weekly_Sales)) %>%
  ggplot(aes(x = Date, y = Mean_Weekly_Sales)) +
    geom_line(color = 'darkblue') + 
  labs(x = 'Дата',
       y = 'Среднее количество проданных товаров')
```

#### Статистики

```{r}
summary(walmart)
```

### Строим модели

Вы предлагаете идеи, и мы строим модели!

<!-- ### Catboost -->

<!-- ```{r} -->
<!-- library(catboost) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- train <- walmart %>% -->
<!--   filter(Date < '2012-04-27') -->
<!-- test <- walmart %>% -->
<!--   filter(Date >= '2012-04-27') -->

<!-- train_X <- train %>% -->
<!--   select(-next_Weekly_Sales) -->
<!-- train_y <- train$next_Weekly_Sales -->

<!-- train_X %>% -->
<!--   mutate_at(vars(Store, Date, Dept, IsHoliday, Type), .funs = as.factor) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- train_pool <- catboost.load_pool(data = train_X, label = train_y) -->
<!-- ``` -->

